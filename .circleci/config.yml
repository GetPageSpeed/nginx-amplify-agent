version: 2.1

executors:
  deploy:
    parameters:
      dist:
        type: string
      arch:
        type: string
    docker:
      - image: kroniak/ssh-client
    working_directory: /output
    environment:
      DISTRO: << parameters.dist >>
      ARCH: << parameters.arch >>
  rpmbuilder:
    parameters:
      dist:
        type: string
      rpmlint:
        type: integer
        default: 1
    docker:
      - image: getpagespeed/rpmbuilder:<< parameters.dist >>
    working_directory: /sources
    environment:
      RPMLINT: << parameters.rpmlint >>
  debbuilder:
    parameters:
      suite:
        type: string
      arch:
        type: string
        default: amd64
    docker:
      # Image tags are like debian-bookworm, ubuntu-jammy (multi-arch, no arch suffix)
      - image: getpagespeed/debbuilder:<< parameters.suite >>
    working_directory: /sources
    environment:
      SUITE: << parameters.suite >>
      ARCH: << parameters.arch >>
  deploy-deb:
    parameters:
      suite:
        type: string
      arch:
        type: string
    docker:
      - image: kroniak/ssh-client
    working_directory: /output
    environment:
      SUITE: << parameters.suite >>
      ARCH: << parameters.arch >>

jobs:
  build-rpm:
    parameters:
      dist:
        description: "The dist tag of OS to build for"
        type: string
      resource_class:
        description: "The resource class to use for the build"
        type: string
        default: "medium"
    resource_class: << parameters.resource_class >>
    executor:
      name: rpmbuilder
      dist: << parameters.dist >>
    steps:
      - checkout
      - run:
          name: "Prepare spec file and sources"
          command: |
            # Copy spec file to root
            cp packages/nginx-amplify-agent/rpm/nginx-amplify-agent.spec .
            cp packages/nginx-amplify-agent/rpm/nginx-amplify-agent.service .

            # Read version from packages/version
            VERSION=$(cat packages/version | cut -d- -f1)
            RELEASE=$(cat packages/version | cut -d- -f2)

            # Substitute version placeholders
            sed -i "s/%%AMPLIFY_AGENT_VERSION%%/$VERSION/g" nginx-amplify-agent.spec
            sed -i "s/%%AMPLIFY_AGENT_RELEASE%%/$RELEASE/g" nginx-amplify-agent.spec

            # Select requirements file based on distro
            # Python 3.6 distros (el7, el8, sles15, amzn2) need older gevent (<24.0)
            # Python 3.9+ distros (el9, el10, fc*, sles16, amzn2023) can use modern gevent
            REQUIREMENTS_FILE="packages/nginx-amplify-agent/requirements.txt"
            DIST="<< parameters.dist >>"
            case "$DIST" in
              el7|el8|sles15|amzn2)
                # Python 3.6/3.7 - need older gevent
                if [ -f "packages/nginx-amplify-agent/requirements-amzn2.txt" ]; then
                  REQUIREMENTS_FILE="packages/nginx-amplify-agent/requirements-amzn2.txt"
                fi
                ;;
              el9|el10|fc*|sles16|amzn2023)
                # Python 3.9+ - can use modern gevent
                if [ -f "packages/nginx-amplify-agent/requirements-rhel9.txt" ]; then
                  REQUIREMENTS_FILE="packages/nginx-amplify-agent/requirements-rhel9.txt"
                fi
                ;;
            esac

            # Substitute requirements file placeholder
            sed -i "s|%%REQUIREMENTS%%|$REQUIREMENTS_FILE|g" nginx-amplify-agent.spec

            echo "Using requirements file: $REQUIREMENTS_FILE"
            cat "$REQUIREMENTS_FILE"
      - run:
          name: "Run the build"
          command: build
      - run:
          name: "Check for RPM files and halt if none exist"
          command: |
            set -x
            if ls /output/*.rpm 1> /dev/null 2>&1; then
              echo "RPM files found. Proceeding with persistence to workspace."
            else
              echo "No RPM files found. Halting this job only."
              circleci-agent step halt
            fi
      - persist_to_workspace:
          root: /output
          paths:
            - "*.rpm"

  deploy-rpm:
    parameters:
      dist:
        description: "The dist tag of OS to deploy for"
        type: string
      arch:
        description: "The architecture to deploy for"
        type: string
    executor:
      name: deploy
      dist: << parameters.dist >>
      arch: << parameters.arch >>
    steps:
      - attach_workspace:
          at: /output
      - add_ssh_keys:
          fingerprints:
            - "8c:a4:dd:2c:47:4c:63:aa:90:0b:e0:d6:15:be:87:82"
      - run:
          name: "Ensure project specific upload directory to avoid deploy collisions"
          command: >
            ssh -o StrictHostKeyChecking=no
            $GPS_BUILD_USER@$GPS_BUILD_SERVER
            "mkdir -p ~/incoming/${CIRCLE_PROJECT_REPONAME}/${DISTRO}/${ARCH}/${CIRCLE_BRANCH}"
      - run:
          name: "Deploy all RPMs to GetPageSpeed repo."
          command: |
            echo "Uploading RPMs..."
            ls -al
            echo "Target upload directory: ~/incoming/${CIRCLE_PROJECT_REPONAME}/${DISTRO}/${ARCH}/${CIRCLE_BRANCH}/"
            scp -o StrictHostKeyChecking=no -q -r *.rpm $GPS_BUILD_USER@$GPS_BUILD_SERVER:~/incoming/${CIRCLE_PROJECT_REPONAME}/${DISTRO}/${ARCH}/${CIRCLE_BRANCH}/
      - run:
          name: "Trigger Deploy Hook."
          command: >
            ssh -o StrictHostKeyChecking=no -q
            $GPS_BUILD_USER@$GPS_BUILD_SERVER
            "nohup ~/scripts/incoming.sh ${CIRCLE_PROJECT_REPONAME}/${DISTRO}/${ARCH}/${CIRCLE_BRANCH}/ > ~/incoming/$CIRCLE_PROJECT_REPONAME/$DISTRO/${ARCH}/${CIRCLE_BRANCH}/process.log 2>&1&"

  build-deb:
    parameters:
      suite:
        description: "The Debian/Ubuntu suite to build for"
        type: string
      arch:
        description: "The architecture to build for"
        type: string
        default: "amd64"
      resource_class:
        description: "The resource class to use for the build"
        type: string
        default: "medium"
    resource_class: << parameters.resource_class >>
    executor:
      name: debbuilder
      suite: << parameters.suite >>
      arch: << parameters.arch >>
    steps:
      - checkout
      - run:
          name: "Prepare DEB package sources"
          command: |
            # The DEB build needs setup from packages directory
            # Copy debian directory to the source root
            cp -r packages/nginx-amplify-agent/deb/debian .

            # Select the right control file for this suite
            # Suite is like "ubuntu-focal" or "debian-bookworm", extract just the codename
            SUITE_NAME=$(echo "<< parameters.suite >>" | sed 's/^ubuntu-//' | sed 's/^debian-//')
            CONTROL_FILE="debian/control.${SUITE_NAME}"
            if [ -f "$CONTROL_FILE" ]; then
              cp "$CONTROL_FILE" debian/control
            else
              # Fall back to a reasonable default
              cp debian/control.bookworm debian/control
            fi

            # Copy setup.py to root (use the DEB-specific one that avoids circular imports)
            if [ -f packages/nginx-amplify-agent/setup-deb.py ]; then
              cp packages/nginx-amplify-agent/setup-deb.py setup.py
            else
              cp packages/nginx-amplify-agent/setup.py .
            fi

            # Select requirements file based on suite
            # Ubuntu focal (20.04) has Python 3.8, jammy (22.04) has 3.10, noble (24.04) has 3.12
            # Debian bookworm has Python 3.11
            # All modern enough to use rhel9 requirements
            REQUIREMENTS_FILE="packages/nginx-amplify-agent/requirements.txt"
            if [ -f "packages/nginx-amplify-agent/requirements-rhel9.txt" ]; then
              REQUIREMENTS_FILE="packages/nginx-amplify-agent/requirements-rhel9.txt"
            fi

            # Substitute requirements placeholder in debian/rules
            sed -i "s|%%REQUIREMENTS%%|$REQUIREMENTS_FILE|g" debian/rules
            echo "Using requirements file: $REQUIREMENTS_FILE"

            # Read version
            VERSION=$(cat packages/version | cut -d- -f1)

            # Create changelog with version (avoiding heredoc due to CircleCI syntax)
            # Use the extracted codename (focal, bookworm) not the full suite name (ubuntu-focal)
            echo "nginx-amplify-agent (${VERSION}-1) ${SUITE_NAME}; urgency=low" > debian/changelog
            echo "" >> debian/changelog
            echo "  * GetPageSpeed Amplify Agent release" >> debian/changelog
            echo "" >> debian/changelog
            echo " -- GetPageSpeed <info@getpagespeed.com>  $(date -R)" >> debian/changelog

            # Debug: show prepared files
            echo "=== debian/control ==="
            cat debian/control
            echo ""
            echo "=== debian/rules ==="
            cat debian/rules
            echo ""
            echo "=== debian/changelog ==="
            cat debian/changelog
            echo ""
            echo "=== setup.py ==="
            cat setup.py
            echo ""
            echo "=== Source directory structure ==="
            ls -la
            echo ""
            echo "=== debian/ directory ==="
            ls -la debian/
      - run:
          name: "Install build dependencies"
          command: |
            apt-get update
            apt-get install -y python3-pip python3-setuptools dh-python debhelper
      - run:
          name: "Build DEB package"
          command: |
            echo "Running dpkg-buildpackage..."
            dpkg-buildpackage -us -uc -b 2>&1 || {
              echo "dpkg-buildpackage failed with exit code $?"
              echo "Showing debian/rules:"
              cat debian/rules
              exit 1
            }
            echo "Build completed. Checking for output..."
            ls -la ../*.deb || echo "No .deb files found in parent directory"
            # Copy .deb files to /output
            cp ../*.deb /output/ 2>/dev/null || echo "No .deb files to copy"
            ls -la /output/
      - run:
          name: "Check for DEB files"
          command: |
            if ls /output/*.deb 1> /dev/null 2>&1; then
              echo "DEB files found. Proceeding."
            else
              echo "No DEB files found. Halting."
              circleci-agent step halt
            fi
      - persist_to_workspace:
          root: /output
          paths:
            - "*.deb"
            - "*.changes"

  deploy-deb:
    parameters:
      suite:
        description: "The Debian/Ubuntu suite to deploy for"
        type: string
      arch:
        description: "The architecture to deploy for"
        type: string
    executor:
      name: deploy-deb
      suite: << parameters.suite >>
      arch: << parameters.arch >>
    steps:
      - attach_workspace:
          at: /output
      - add_ssh_keys:
          fingerprints:
            - "8c:a4:dd:2c:47:4c:63:aa:90:0b:e0:d6:15:be:87:82"
      - run:
          name: "Ensure project specific upload directory"
          command: >
            ssh -o StrictHostKeyChecking=no
            $GPS_BUILD_USER@$GPS_BUILD_SERVER
            "mkdir -p ~/incoming/${CIRCLE_PROJECT_REPONAME}/${SUITE}/${ARCH}/${CIRCLE_BRANCH}"
      - run:
          name: "Deploy all DEBs to GetPageSpeed repo."
          command: |
            echo "Uploading DEBs..."
            ls -al
            # Upload .deb files (required) and .changes files (optional)
            scp -o StrictHostKeyChecking=no -q -r *.deb $GPS_BUILD_USER@$GPS_BUILD_SERVER:~/incoming/${CIRCLE_PROJECT_REPONAME}/${SUITE}/${ARCH}/${CIRCLE_BRANCH}/
            if ls *.changes 1>/dev/null 2>&1; then
              scp -o StrictHostKeyChecking=no -q -r *.changes $GPS_BUILD_USER@$GPS_BUILD_SERVER:~/incoming/${CIRCLE_PROJECT_REPONAME}/${SUITE}/${ARCH}/${CIRCLE_BRANCH}/
            fi
      - run:
          name: "Trigger Deploy Hook."
          command: >
            ssh -o StrictHostKeyChecking=no -q
            $GPS_BUILD_USER@$GPS_BUILD_SERVER
            "nohup ~/scripts/incoming-deb.sh ${CIRCLE_PROJECT_REPONAME}/${SUITE}/${ARCH}/${CIRCLE_BRANCH}/ > ~/incoming/$CIRCLE_PROJECT_REPONAME/$SUITE/${ARCH}/${CIRCLE_BRANCH}/process.log 2>&1&"

workflows:
  build-and-deploy:
    jobs:
      # RPM builds
      - build-rpm:
          context: org-global
          dist: el7
          name: build-el7-x86_64
      - deploy-rpm:
          arch: x86_64
          context: org-global
          dist: el7
          name: deploy-el7-x86_64
          requires: [build-el7-x86_64]

      - build-rpm:
          context: org-global
          dist: el8
          name: build-el8-x86_64
      - deploy-rpm:
          arch: x86_64
          context: org-global
          dist: el8
          name: deploy-el8-x86_64
          requires: [build-el8-x86_64]

      - build-rpm:
          context: org-global
          dist: el9
          name: build-el9-x86_64
      - deploy-rpm:
          arch: x86_64
          context: org-global
          dist: el9
          name: deploy-el9-x86_64
          requires: [build-el9-x86_64]

      - build-rpm:
          context: org-global
          dist: amzn2
          name: build-amzn2-x86_64
      - deploy-rpm:
          arch: x86_64
          context: org-global
          dist: amzn2
          name: deploy-amzn2-x86_64
          requires: [build-amzn2-x86_64]

      - build-rpm:
          context: org-global
          dist: amzn2023
          name: build-amzn2023-x86_64
      - deploy-rpm:
          arch: x86_64
          context: org-global
          dist: amzn2023
          name: deploy-amzn2023-x86_64
          requires: [build-amzn2023-x86_64]

      - build-rpm:
          context: org-global
          dist: fc42
          name: build-fc42-x86_64
      - deploy-rpm:
          arch: x86_64
          context: org-global
          dist: fc42
          name: deploy-fc42-x86_64
          requires: [build-fc42-x86_64]

      - build-rpm:
          context: org-global
          dist: fc43
          name: build-fc43-x86_64
      - deploy-rpm:
          arch: x86_64
          context: org-global
          dist: fc43
          name: deploy-fc43-x86_64
          requires: [build-fc43-x86_64]

      - build-rpm:
          context: org-global
          dist: sles15
          name: build-sles15-x86_64
      - deploy-rpm:
          arch: x86_64
          context: org-global
          dist: sles15
          name: deploy-sles15-x86_64
          requires: [build-sles15-x86_64]

      - build-rpm:
          context: org-global
          dist: sles16
          name: build-sles16-x86_64
      - deploy-rpm:
          arch: x86_64
          context: org-global
          dist: sles16
          name: deploy-sles16-x86_64
          requires: [build-sles16-x86_64]

      # DEB builds
      - build-deb:
          context: org-global
          suite: ubuntu-focal
          arch: amd64
          name: build-focal-amd64
      - deploy-deb:
          arch: amd64
          context: org-global
          suite: ubuntu-focal
          name: deploy-focal-amd64
          requires: [build-focal-amd64]

      - build-deb:
          context: org-global
          suite: ubuntu-jammy
          arch: amd64
          name: build-jammy-amd64
      - deploy-deb:
          arch: amd64
          context: org-global
          suite: ubuntu-jammy
          name: deploy-jammy-amd64
          requires: [build-jammy-amd64]

      - build-deb:
          context: org-global
          suite: ubuntu-noble
          arch: amd64
          name: build-noble-amd64
      - deploy-deb:
          arch: amd64
          context: org-global
          suite: ubuntu-noble
          name: deploy-noble-amd64
          requires: [build-noble-amd64]

      - build-deb:
          context: org-global
          suite: debian-bookworm
          arch: amd64
          name: build-bookworm-amd64
      - deploy-deb:
          arch: amd64
          context: org-global
          suite: debian-bookworm
          name: deploy-bookworm-amd64
          requires: [build-bookworm-amd64]
